sources:
    mapzen:
        rasters:
            - normals
    normals:
        type: Raster
        url: https://tile.mapzen.com/mapzen/terrain/v1/normal/{z}/{x}/{y}.png
        url_params:
            api_key: global.sdk_mapzen_api_key
        max_zoom: 15

textures:
    palette:
        url: images/ramp.png
layers:
    earth:
        data: { source: mapzen }
        draw:
            polygons:
                style: terrain-pattern-earth
                order: function() { return feature.sort_rank || 0; }
                color: global.lightest_color
                #visible: false
            lines:
                visible: false

    landuse:
        national_park:
            draw:
                polygons:
                    style: terrain-pattern-landuse
            us_national_park:
                draw:
                    polygons:
                        style: terrain-pattern-landuse

        conservation:
            draw:
                polygons:
                    style: terrain-pattern-landuse

        national_forest_level_6:
            draw:
                polygons:
                    style: terrain-pattern-landuse

        forest-landcover:
            draw:
                polygons:
                    style: terrain-pattern-landuse

        parks-and-national-forests-not-national-park:
            draw:
                polygons:
                    style: terrain-pattern-landuse
            national_park:
                draw:
                    polygons:
                        style: terrain-pattern-landuse

        farm:
            draw:
                polygons:
                    style: terrain-pattern-landuse

        university:
            enabled: false

        cemetery:
            draw:
                polygons:
                    style: terrain-pattern-landuse

        golf_course:
            draw:
                polygons:
                    style: terrain-pattern-landuse

        hospital:
            enabled: false

        sports_centre:
            enabled: false

        recreation_ground:
            draw:
                polygons:
                    style: terrain-pattern-landuse

        stadium:
            enabled: false

        zoo:
            draw:
                polygons:
                    style: terrain-pattern-landuse

        winter_sports:
            draw:
                polygons:
                    style: terrain-pattern-landuse

        man-made:
            enabled: false

        tier5:
            tourism-related:
                draw:
                    polygons:
                        style: terrain-pattern-landuse

            beach:
                draw:
                    polygons:
                        style: terrain-pattern-landuse

        garden:
            draw:
                polygons:
                    style: terrain-pattern-landuse

        parking:
            enabled: false

        pedestrian:
            enabled: false

        pitch:
            draw:
                polygons:
                    style: terrain-pattern-landuse

        playground:
            draw:
                polygons:
                    style: terrain-pattern-landuse

        school:
            enabled: false

        minor-landuse:
            enabled: false

        landuse-not-filtered:
            enabled: false

        retaining_wall:
            enabled: false

        fence:
            enabled: false

styles:
    riverlines:
        shaders:
            uniforms:
                u_tint: global.pattern_river_tint
                u_fill: global.pattern_river_fill

    functions-zoom:
        mix:
            - functions-easing
        shaders:
            defines:
                ZOOM_START: 14
                ZOOM_END: 20
                ZOOM_MAX: 'max(ZOOM_START, ZOOM_END)'
                ZOOM_FNC: linear
                ZOOM_IN: 0
                ZOOM_OUT: 1
            blocks:
                global: |
                    float zoom() {
                        return mix( ZOOM_IN,
                                    ZOOM_OUT,
                                    clamp( smoothstep(  ZOOM_START/ZOOM_MAX,
                                                        ZOOM_END/ZOOM_MAX,
                                                        max(u_map_position.z/ZOOM_MAX, 0.)), 0., 1.) );
                    }

                    float zoomEase() {
                        return mix( ZOOM_IN,
                                    ZOOM_OUT,
                                    (u_map_position.z-ZOOM_START)/(ZOOM_END-ZOOM_START) );
                    }

    elevation-dash:
        base: polygons
        mix:
            - polygons-diagonal-dash
        raster: custom
        shaders:
            defines:
                DASH_COLOR: color.rgb*.5
                DASH_BACKGROUND_COLOR: color.rgb
                DASH_SCALE: 10
                DASH_SIZE: 0.9
                DASH_TYPE: fill
                DASH_TILE_STYLE: tile
                DASH_DIR: vec3(-0.600,-0.420,0.560)
                NORMAL_TEXTURE_INDEX: 0
                DASH_MIN_SIZE: 0.8
                DASH_MAX_SIZE: 1
            blocks:
                normal: >
                    float shade = dot((sampleRaster(int(NORMAL_TEXTURE_INDEX)).rgb-.5)*2.,
                    DASH_DIR);

                    shade = mix(DASH_MIN_SIZE, DASH_MAX_SIZE, (shade*shade*shade)*4.);

    polygons-diagonal-dash:
        base: polygons
        mix:
            - space-tile
            - tiling-brick
            - tiling-tile
            - shapes-type
        shaders:
            defines:
                DASH_COLOR: color.rgb*.5
                DASH_BACKGROUND_COLOR: color.rgb
                DASH_SCALE: 10
                DASH_SIZE: 0.9
                DASH_TYPE: fill
                DASH_TILE_STYLE: tile
                PI: 3.141592653589793
            blocks:
                global: |
                    float dashDF(vec2 st) {
                        return min(cos((st.x-st.y)*PI),-cos((st.x+st.y+.5)*PI*.6666)*5.);
                    }
                color: |
                    color.rgb = mix(DASH_BACKGROUND_COLOR,
                                    DASH_COLOR,
                                    DASH_TYPE( DASH_SIZE, dashDF(DASH_TILE_STYLE(getTileCoords()*DASH_SCALE,3.))) );

    shapes-type:
        mix:
            - functions-aastep
        shaders:
            defines:
                STROKE: 0.15
            blocks:
                global: |
                    float fill (in float size, in float x) {
                        return 1.-aastep(size, x);
                    }

                    float stroke (in float size, in float x) {
                        return aastep(size, x+STROKE*.5) - aastep(size, x-STROKE*.5);
                    }

    elevation-normal:
        raster: custom
        shaders:
            defines:
                NORMAL_TEXTURE_INDEX: 0
            blocks:
                normal: |
                    vec4 normal_elv_raster = sampleRaster(int(NORMAL_TEXTURE_INDEX));
                    normal = (normal_elv_raster.rgb-.5)*2.;

    polygons-dots:
        base: polygons
        mix:
            - space-tile
            - tiling-brick
            - shapes-circle
        shaders:
            blocks:
                global: |
                    float TileDots(float scale, float size) {

                        // controls
                        float DOT_SIZE = size * .1; // bigger value = smaller dots
                        float SPEED = 2.; // bigger value = faster transition

                        vec2 tc = getTileCoords() * size * pow(2., floor(u_map_position.z) - abs(u_tile_origin.z));
                        vec2 IN = brick(tc, 2.);
                        float A = circleDF(vec2(.5) - IN) * DOT_SIZE;
                        vec2 OUT = brick(tc, 4.);
                        float B = circleDF(vec2(.5) - OUT) * DOT_SIZE;

                        // keep B dots big as they fade in, to maintain density
                        B *= pow(fract(u_map_position.z)*.95, SPEED);

                        float d = mix(A, B, pow(fract(u_map_position.z), SPEED));
                        return aastep(scale, d);
                    }

                color: |
                    color.rgb = mix(DOTS_COLOR, DOTS_BACKGROUND_COLOR, TileDots(DOTS_SIZE, DOTS_SCALE));

    shapes-circle:
        mix:
            - shapes-type
        shaders:
            blocks:
                global: |
                    // get distance field of a Circle
                    float circleDF (vec2 st) {
                                    return dot(st,st)*3.03;
                    }




    terrain-pattern:
        base: polygons
        mix: [elevation-normal, functions-zoom, polygons-dots]
        shaders:
            defines:
                ZOOM_START: 0.
                ZOOM_END: 13.
                DOTS_DIR: vec3(0.600,-0.950,0.520)
                DOTS_COLOR: vec3(0.)
                DOTS_BACKGROUND_COLOR: vec3(1.)
                DOTS_SCALE: 30
                DOTS_SIZE: mix(shade*10.,shade*2.,zoom())
            blocks:
                normal: |
                    float shade = dot(normal, DOTS_DIR);
                    // modify brightness and contrast
                    shade = shade*shade*shade * -2. + .65;
                    // reset normal to prevent standard terrain shading mixing with dots
                    normal = vec3(0,0,1);

    terrain-pattern-earth:
        base: polygons
        mix: [elevation-ramp, terrain-pattern, colorized-earth]

    terrain-pattern-landuse:
        base: polygons
        mix: [elevation-ramp, terrain-pattern, colorized-landuse]

    elevation-ramp:
        shaders:
            uniforms:
                u_ramp: palette
            blocks:
                color: |
                    color = texture2D(u_ramp, vec2((1.-normal_elv_raster.a),.5));
        raster: custom

    colorized-earth:
        shaders:
            uniforms:
                u_tint: global.pattern_dark_earth_dot_color
                u_fill: global.pattern_dark_earth_fill_color
            blocks:
                filter: |
                    color.rgb = mix(u_tint.rgb, u_fill.rgb, color.rgb);

    colorized-landuse:
        shaders:
            uniforms:
                u_tint: global.pattern_dark_landuse_dot_color
                u_fill: global.pattern_dark_landuse_fill_color
            blocks:
                filter: |
                    color.rgb = mix(u_tint.rgb, u_fill.rgb, color.rgb);